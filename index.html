<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Audio Speed Controller</title>
    <style>
        body {
            background-color: #0e0e0e;
            color: #ffffff;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            margin: 0;
            padding: 40px;
        }
        h1 {
            color: #3a3aff;
            text-shadow: 0 0 12px #3a3aff;
        }
        .controls {
            margin: 20px auto;
            padding: 20px;
            background: #1b1b1b;
            border-radius: 16px;
            width: 400px;
            box-shadow: 0 0 20px rgba(58, 58, 255, 0.3);
        }
        input[type=range] {
            width: 80%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            outline: none;
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #3a3aff;
            border: 2px solid #fff;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px #3a3aff;
        }
        #playButton {
            background: #3a3aff;
            border: none;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px #3a3aff;
            transition: 0.2s;
        }
        #playButton:hover {
            background: #5d5dff;
        }
        label, p {
            font-size: 14px;
            color: #ccc;
        }
        #fileInput {
            margin: 10px;
            padding: 10px;
            background: #1b1b1b;
            color: #fff;
            border: 1px solid #3a3aff;
            border-radius: 8px;
            cursor: pointer;
        }
        #seekBar, #speedControl {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Web Audio Speed Controller</h1>
    <input type="file" id="fileInput" accept="audio/*">
    <audio id="audio1"></audio>
    <audio id="audio2"></audio>

    <div>
        <p>Position: <span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>
        <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1">
    </div>

    <p>Speed: <span id="speedValue">1.0</span>x</p>
    <input type="range" id="speedControl" min="-4.0" max="2.0" step="0.01" value="1.0">
    <br><br>
    <button id="playButton">â–¶ Play / Pause</button>

    <div class="controls">
        <label>Segment Duration (s): <input type="number" id="chunkLength" value="1" step="0.1" min="0.1"></label><br>
        <label>Step Back (s): <input type="number" id="jumpSize" value="0.5" step="0.1" min="0.1"></label><br>
        <label>Update Interval (ms): <input type="number" id="updateInterval" value="500" step="50" min="250"></label><br>
        <label>Reverse Playback Speed: <input type="number" id="reversePlaybackSpeed" value="1.0" step="0.1" min="0.1" max="2.0" readonly></label>
    </div>

    <script>
        const fileInput = document.getElementById("fileInput");
        const audio1 = document.getElementById("audio1");
        const audio2 = document.getElementById("audio2");
        const speedSlider = document.getElementById("speedControl");
        const speedValue = document.getElementById("speedValue");
        const playButton = document.getElementById("playButton");
        const chunkLengthInput = document.getElementById("chunkLength");
        const jumpSizeInput = document.getElementById("jumpSize");
        const updateIntervalInput = document.getElementById("updateInterval");
        const reversePlaybackSpeedInput = document.getElementById("reversePlaybackSpeed");
        const seekBar = document.getElementById("seekBar");
        const currentTimeDisplay = document.getElementById("currentTime");
        const durationDisplay = document.getElementById("duration");

        let audioContext;
        let source1, source2;
        let gainNode1, gainNode2;
        let initialized = false;
        let intervalId = null;
        let currentSpeed = 1.0;
        let isPlaying = false;
        let currentPosition = 0;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function initAudioContext() {
            if (!initialized) {
                audioContext = new AudioContext();
                source1 = audioContext.createMediaElementSource(audio1);
                source2 = audioContext.createMediaElementSource(audio2);
                gainNode1 = audioContext.createGain();
                gainNode2 = audioContext.createGain();
                source1.connect(gainNode1);
                source2.connect(gainNode2);
                gainNode1.connect(audioContext.destination);
                gainNode2.connect(audioContext.destination);
                initialized = true;
            }
        }

        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                audio1.src = url;
                audio2.src = url;
                audio1.load();
                audio2.load();
                audio1.addEventListener("loadedmetadata", () => {
                    seekBar.max = audio1.duration;
                    durationDisplay.textContent = formatTime(audio1.duration);
                });
            }
        });

        setInterval(() => {
            if (isPlaying) {
                currentTimeDisplay.textContent = formatTime(currentPosition);
                seekBar.value = currentPosition;
            }
        }, 100);

        seekBar.addEventListener("input", () => {
            currentPosition = parseFloat(seekBar.value);
            currentTimeDisplay.textContent = formatTime(currentPosition);
            if (currentSpeed >= 0) {
                audio1.currentTime = currentPosition;
                audio2.currentTime = currentPosition;
            }
        });

        function startBackwardPlayback() {
            if (intervalId) clearInterval(intervalId);
            const updateInterval = parseInt(updateIntervalInput.value);
            const chunkLength = parseFloat(chunkLengthInput.value);
            const jumpSize = parseFloat(jumpSizeInput.value);
            const playbackSpeed = Math.max(0.1, Math.min(2.0, (chunkLength * 1000) / updateInterval));
            let useAudio1 = true;
            currentPosition = Math.max(0, currentPosition);
            audio1.currentTime = currentPosition;
            audio1.playbackRate = playbackSpeed;
            audio1.play();
            gainNode1.gain.value = 1.0;
            gainNode2.gain.value = 0;
            intervalId = setInterval(() => {
                if (!isPlaying) return;
                currentPosition = Math.max(0, currentPosition - jumpSize);
                const active = useAudio1 ? audio2 : audio1;
                const fadeIn = useAudio1 ? gainNode2 : gainNode1;
                const fadeOut = useAudio1 ? gainNode1 : gainNode2;
                fadeIn.gain.value = 1.0;
                fadeOut.gain.value = 0;
                active.currentTime = currentPosition;
                active.playbackRate = playbackSpeed;
                active.play();
                useAudio1 = !useAudio1;
                if (currentPosition <= 0) stopPlayback();
            }, updateInterval);
        }

        function stopBackwardPlayback() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            audio1.pause();
            audio2.pause();
        }

        function startForwardPlayback() {
            stopBackwardPlayback();
            audio2.pause();
            audio1.currentTime = currentPosition;
            audio1.playbackRate = Math.max(0.0625, currentSpeed);
            audio1.play();
            const updatePos = setInterval(() => {
                if (!isPlaying || currentSpeed < 0) clearInterval(updatePos);
                currentPosition = audio1.currentTime;
            }, 100);
        }

        function stopPlayback() {
            isPlaying = false;
            stopBackwardPlayback();
            audio1.pause();
            audio2.pause();
        }

        playButton.addEventListener("click", () => {
            initAudioContext();
            if (isPlaying) {
                stopPlayback();
            } else {
                isPlaying = true;
                if (currentSpeed < 0) {
                    startBackwardPlayback();
                } else {
                    startForwardPlayback();
                }
            }
        });

        let speedChangeTimeout;
        speedSlider.addEventListener("input", () => {
            const prevSpeed = currentSpeed;
            currentSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = currentSpeed.toFixed(2);
            const crossedZero = (prevSpeed >= 0 && currentSpeed < 0) || (prevSpeed < 0 && currentSpeed >= 0);
            if (isPlaying && crossedZero) {
                if (currentSpeed >= 0) startForwardPlayback();
                else startBackwardPlayback();
            }
            clearTimeout(speedChangeTimeout);
            speedChangeTimeout = setTimeout(() => {
                if (isPlaying && currentSpeed < 0) startBackwardPlayback();
            }, 300);
            if (isPlaying && currentSpeed >= 0) {
                audio1.playbackRate = Math.max(0.0625, currentSpeed);
            }
        });
    </script>
</body>
</html>
