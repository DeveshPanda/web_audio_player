<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> ðŸŽµ Web Audio Player ðŸŽµ </title>
    <style>
        body {
            background-color: #0e0e0e;
            color: #ffffff;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            margin: 0;
            padding: 40px;
        }
        h1 {
            color: #3a3aff;
            text-shadow: 0 0 12px #3a3aff;
        }
        .controls {
            margin: 20px auto;
            padding: 20px;
            background: #1b1b1b;
            border-radius: 16px;
            width: 400px;
            box-shadow: 0 0 20px rgba(58, 58, 255, 0.3);
        }
        input[type=range] {
            width: 80%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            outline: none;
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #3a3aff;
            border: 2px solid #fff;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px #3a3aff;
        }
        #playButton {
            background: #3a3aff;
            border: none;
            color: white;
            font-size: 16px;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px #3a3aff;
            transition: 0.2s;
        }
        #playButton:hover {
            background: #5d5dff;
        }
        label, p {
            font-size: 14px;
            color: #ccc;
        }
        #fileInput {
            margin: 10px;
            padding: 10px;
            background: #1b1b1b;
            color: #fff;
            border: 1px solid #3a3aff;
            border-radius: 8px;
            cursor: pointer;
        }
        #seekBar, #speedControl {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Audio Playback/Speed Controls </h1>
    <input type="file" id="fileInput" accept="audio/*">
    <audio id="audio1"></audio>
    <audio id="audio2"></audio>

    <div>
        <p>Position: <span id="currentTime">0:00</span> / <span id="duration">0:00</span></p>
        <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1">
    </div>

    <p>Speed: <span id="speedValue">1.0</span>x</p>
    <input type="range" id="speedControl" min="-4.0" max="2.0" step="0.01" value="1.0">
    <br><br>
    <button id="playButton">â–¶ Play / Pause</button>

    <div class="controls">
        <label>Segment Duration (s): <input type="number" id="chunkLength" value="1" step="0.1" min="0.1"></label><br>
        <label>Step Back (s): <input type="number" id="jumpSize" value="0.5" step="0.1" min="0.1"></label><br>
        <label>Update Interval (ms): <input type="number" id="updateInterval" value="500" step="50" min="250"></label><br>
        <label>Reverse Playback Speed: <input type="number" id="reversePlaybackSpeed" value="1.0" step="0.1" min="0.1" max="2.0" readonly></label>
    </div>

    <script>
        const fileInput = document.getElementById("fileInput");
        const audio1 = document.getElementById("audio1");
        const audio2 = document.getElementById("audio2");
        const speedSlider = document.getElementById("speedControl");
        const speedValue = document.getElementById("speedValue");
        const playButton = document.getElementById("playButton");
        const chunkLengthInput = document.getElementById("chunkLength");
        const jumpSizeInput = document.getElementById("jumpSize");
        const updateIntervalInput = document.getElementById("updateInterval");
        const reversePlaybackSpeedInput = document.getElementById("reversePlaybackSpeed");
        const seekBar = document.getElementById("seekBar");
        const currentTimeDisplay = document.getElementById("currentTime");
        const durationDisplay = document.getElementById("duration");

        let initialized = false;
        let isPlaying = false;
        let currentSpeed = 1.0;
        let currentPosition = 0;
        let activeInterval = null;
        let targetPosition = 0;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function initAudio() {
            if (initialized) return;
            initialized = true;
        }

        fileInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            [audio1, audio2].forEach(a => { a.src = url; a.load(); });
            audio1.onloadedmetadata = () => {
                seekBar.max = audio1.duration;
                durationDisplay.textContent = formatTime(audio1.duration);
            };
        });

        function updateSeekBar() {
            if (!isPlaying) return;
            if (currentSpeed >= 0) currentPosition = audio1.currentTime;
            else currentPosition = targetPosition;
            seekBar.value = currentPosition;
            currentTimeDisplay.textContent = formatTime(currentPosition);
            requestAnimationFrame(updateSeekBar);
        }

        seekBar.addEventListener("input", () => {
            targetPosition = parseFloat(seekBar.value);
        });

        function smoothTransitionToTarget() {
            const alpha = 0.15;
            const dt = 0.016;
            currentPosition += -alpha * (currentPosition - targetPosition);
            [audio1, audio2].forEach(a => a.currentTime = currentPosition);
        }

        function startForwardPlayback() {
            clearInterval(activeInterval);
            audio2.pause();
            audio1.currentTime = currentPosition;
            audio1.playbackRate = Math.max(0.0625, currentSpeed);
            audio1.play();
            requestAnimationFrame(updateSeekBar);
        }

        function startBackwardPlayback() {
            clearInterval(activeInterval);
            const updateInterval = parseInt(updateIntervalInput.value);
            const jumpSize = parseFloat(jumpSizeInput.value);
            const playbackSpeed = parseFloat(reversePlaybackSpeedInput.value);
            let useAudio1 = true;

            activeInterval = setInterval(() => {
                if (!isPlaying) return;
                smoothTransitionToTarget();
                currentPosition = Math.max(0, currentPosition - jumpSize);
                const active = useAudio1 ? audio1 : audio2;
                const inactive = useAudio1 ? audio2 : audio1;

                inactive.pause();
                active.currentTime = currentPosition;
                active.playbackRate = playbackSpeed;
                active.play();
                useAudio1 = !useAudio1;

                if (currentPosition <= 0) stopPlayback();
            }, updateInterval);

            requestAnimationFrame(updateSeekBar);
        }

        function stopPlayback() {
            isPlaying = false;
            clearInterval(activeInterval);
            [audio1, audio2].forEach(a => a.pause());
        }

        playButton.addEventListener("click", () => {
            initAudio();
            if (isPlaying) {
                stopPlayback();
            } else {
                isPlaying = true;
                if (currentSpeed < 0) startBackwardPlayback();
                else startForwardPlayback();
            }
        });

        speedSlider.addEventListener("input", () => {
            const prevSpeed = currentSpeed;
            currentSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = currentSpeed.toFixed(2);
            const crossed = (prevSpeed >= 0 && currentSpeed < 0) || (prevSpeed < 0 && currentSpeed >= 0);
            if (isPlaying && crossed) {
                stopPlayback();
                setTimeout(() => {
                    if (currentSpeed < 0) startBackwardPlayback();
                    else startForwardPlayback();
                }, 100);
            } else if (isPlaying && currentSpeed >= 0) {
                audio1.playbackRate = Math.max(0.0625, currentSpeed);
            }
        });
    </script>
</body>
</html>
